#set the flags
SET GLOBAL innodb_file_per_table=on;
SET GLOBAL innodb_file_format=`1`;
#check the flag is set to 1
SELECT @@innodb_log_compressed_pages;
@@innodb_log_compressed_pages
1
CREATE TABLE t1(id int primary key, a text) 
ENGINE=innodb key_block_size=1;
# start session
# insert some rows to trigger btr page reorg
#Check recovery on INSERT operation.
# Insert a record & crash the server before commit
# Request a crash on next execution of commit.
# Write file to make mysql-test-run.pl start up the server again
# Execute the statement that causes the crash.
#check if recovery went fine, should show count=1
SELECT COUNT(*) FROM t1 WHERE id = 101;
COUNT(*)
1
#Check recovery on UPDATE operation.
BEGIN;
# Insert a record & crash the server after commit
UPDATE t1 SET a = "updated_col";
# Request a crash on next execution of commit.
SET SESSION debug="+d,crash_commit_after_prepare";
# Write file to make mysql-test-run.pl start up the server again
# Execute the statement that causes the crash.
COMMIT;
#check if recovery went fine, should show count=101
SELECT COUNT(*) FROM t1 WHERE a = "updated_col";
COUNT(*)
101
#Check recovery on DELETE operation.
BEGIN;
# Insert a record & crash the server after commit
DELETE FROM t1;
# Request a crash on next execution of commit.
SET SESSION debug="+d,crash_commit_after_prepare";
# Write file to make mysql-test-run.pl start up the server again
# Execute the statement that causes the crash.
COMMIT;
#check if recovery went fine, should show count=0
SELECT COUNT(*) FROM t1;
COUNT(*)
0
#clean up
DROP TABLE t1;
